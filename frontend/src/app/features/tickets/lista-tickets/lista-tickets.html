<div class="tickets-container">
  <!-- Header -->
  <div class="tickets-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1>
            <i class="fas fa-ticket-alt"></i>
            Gestión de Tickets
          </h1>
          <p *ngIf="currentUser">{{ currentUser.nombre }} {{ currentUser.apellido }} - {{ currentUser.rol }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <button class="btn btn-light btn-lg" routerLink="/tickets/nuevo" *ngIf="canCreateTicket()">
            <i class="fas fa-plus"></i>
            Nuevo Ticket
          </button>
          <button class="btn btn-outline-light btn-lg ms-2" routerLink="/dashboard">
            <i class="fas fa-home"></i>
            Dashboard
          </button>
          <button class="btn btn-outline-light btn-lg ms-2" (click)="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Salir
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="container mt-4">
    <div class="card filters-card">
      <div class="card-body">
        <div class="row g-3">
          <!-- Búsqueda -->
          <div class="col-md-5">
            <label class="form-label fw-bold">
              <i class="fas fa-search"></i>
              Buscar
            </label>
            <input
              type="text"
              class="form-control"
              placeholder="Buscar por número, cliente, equipo..."
              [formControl]="searchControl"
            />
          </div>

          <!-- Filtro por Estado -->
          <div class="col-md-4">
            <label class="form-label fw-bold">
              <i class="fas fa-filter"></i>
              Filtrar por Estado
            </label>
            <select class="form-select" [formControl]="estadoFilterControl">
              <option value="">Todos los estados</option>
              <option *ngFor="let estado of estados" [value]="estado">
                {{ formatEstado(estado) }}
              </option>
            </select>
          </div>

          <!-- Acciones -->
          <div class="col-md-3 d-flex align-items-end">
            <button
              class="btn btn-outline-secondary w-100"
              (click)="clearFilters()"
              [disabled]="!searchControl.value && !estadoFilterControl.value"
            >
              <i class="fas fa-times"></i>
              Limpiar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mt-4">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon bg-primary">
            <i class="fas fa-ticket-alt"></i>
          </div>
          <div class="stat-info">
            <h3>{{ totalElements }}</h3>
            <p>Total Tickets</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon bg-warning">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3>{{ tickets.filter(t => t.estado === 'INGRESADO' || t.estado === 'ASIGNADO').length }}</h3>
            <p>Pendientes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon bg-info">
            <i class="fas fa-wrench"></i>
          </div>
          <div class="stat-info">
            <h3>{{ tickets.filter(t => t.estado === 'EN_REPARACION' || t.estado === 'EN_PRUEBAS').length }}</h3>
            <p>En Proceso</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon bg-success">
            <i class="fas fa-check"></i>
          </div>
          <div class="stat-info">
            <h3>{{ tickets.filter(t => t.estado === 'LISTO_ENTREGA').length }}</h3>
            <p>Listos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="alert alert-danger mt-3" *ngIf="errorMessage">
      <i class="fas fa-exclamation-circle"></i>
      {{ errorMessage }}
    </div>

    <!-- Loading State -->
    <div class="text-center my-5" *ngIf="isLoading">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 text-muted">Cargando tickets...</p>
    </div>

    <!-- Tickets Table -->
    <div class="card mt-4" *ngIf="!isLoading">
      <div class="card-header bg-white">
        <h5 class="mb-0">
          <i class="fas fa-list"></i>
          Lista de Tickets
        </h5>
      </div>
      <div class="card-body p-0">
        <!-- Empty State -->
        <div class="text-center py-5" *ngIf="tickets.length === 0">
          <i class="fas fa-ticket-alt fa-4x text-muted mb-3"></i>
          <h4 class="text-muted">No se encontraron tickets</h4>
          <p class="text-muted">
            {{ searchControl.value || estadoFilterControl.value ? 'Intenta con otros filtros' : 'Comienza creando un nuevo ticket' }}
          </p>
          <button class="btn btn-primary" routerLink="/tickets/nuevo" *ngIf="!searchControl.value && !estadoFilterControl.value && canCreateTicket()">
            <i class="fas fa-plus"></i>
            Crear Primer Ticket
          </button>
        </div>

        <!-- Table -->
        <div class="table-responsive" *ngIf="tickets.length > 0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Número</th>
                <th>Cliente</th>
                <th>Equipo</th>
                <th>Estado</th>
                <th>Prioridad</th>
                <th>Técnico</th>
                <th>Fecha Ingreso</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let ticket of tickets">
                <td class="align-middle">
                  <strong class="text-primary">{{ ticket.numeroTicket }}</strong>
                </td>
                <td class="align-middle">
                  <div>
                    <strong>{{ ticket.cliente.nombre }}</strong>
                  </div>
                  <small class="text-muted">
                    <i class="fas fa-phone"></i>
                    {{ ticket.cliente.telefono }}
                  </small>
                </td>
                <td class="align-middle">
                  <div>
                    <strong>{{ ticket.tipoEquipo }}</strong>
                  </div>
                  <small class="text-muted" *ngIf="ticket.marca || ticket.modelo">
                    {{ ticket.marca }} {{ ticket.modelo }}
                  </small>
                </td>
                <td class="align-middle">
                  <span class="badge" [ngClass]="getEstadoBadgeClass(ticket.estado)">
                    {{ formatEstado(ticket.estado) }}
                  </span>
                </td>
                <td class="align-middle">
                  <span class="badge" [ngClass]="getPrioridadBadgeClass(ticket.prioridad)">
                    {{ ticket.prioridad }}
                  </span>
                </td>
                <td class="align-middle">
                  <span *ngIf="ticket.tecnicoAsignado">
                    <i class="fas fa-user-cog"></i>
                    {{ ticket.tecnicoAsignado.nombre }}
                  </span>
                  <span *ngIf="!ticket.tecnicoAsignado" class="text-muted">
                    <i class="fas fa-minus"></i>
                    Sin asignar
                  </span>
                </td>
                <td class="align-middle">
                  {{ formatFecha(ticket.fechaIngreso) }}
                </td>
                <td class="align-middle text-center">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    [routerLink]="['/tickets', ticket.id]"
                    title="Ver detalle"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="card-footer bg-white" *ngIf="totalPages > 1">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item" [class.disabled]="currentPage === 0">
              <button class="page-link" (click)="onPageChange(currentPage - 1)">
                <i class="fas fa-chevron-left"></i>
                Anterior
              </button>
            </li>

            <li
              class="page-item"
              *ngFor="let page of [].constructor(totalPages); let i = index"
              [class.active]="i === currentPage"
            >
              <button class="page-link" (click)="onPageChange(i)">
                {{ i + 1 }}
              </button>
            </li>

            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <button class="page-link" (click)="onPageChange(currentPage + 1)">
                Siguiente
                <i class="fas fa-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>

        <div class="text-center mt-2">
          <small class="text-muted">
            Mostrando {{ tickets.length }} de {{ totalElements }} tickets
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
